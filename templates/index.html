<!--
  ~ Copyright (c) 2021. K2-Software
  ~ All software, both binary and source published by K2-Software (hereafter, Software) is copyrighted by the
  ~ author (hereafter, K2-Software) and ownership of all right, title and interest in and to the Software remains
  ~ with K2-Software. By using or copying the Software, User agrees to abide by the terms of this Agreement.
  -->

<!DOCTYPE HTML>

<head lang="en">
    <meta charset="UTF-8">
    <title>Text Tagger</title>

    <link rel="shortcut icon" type="image/ico" href="/resources/favicon.ico">

    <link rel="stylesheet" href="/resources/css/site.css" />

    <link rel="stylesheet" type="text/css" href="/resources/dist/bootstrap-4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="/resources/dist/fontawesome-6.1.1/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="/resources/dist/datatables/datatables.min.css" />

    <script type="text/javascript" src="/resources/dist/jquery-3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="/resources/dist/bootstrap-4.3.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/resources/dist/angularjs-1.8.2/angular.min.js"></script>
    <script type="text/javascript" src="/resources/dist/datatables/datatables.min.js"></script>

    <script src="/resources/js/site.js"></script>
</head>

<body ng-app="categoryConfigApp">

    <script type="text/javascript">
        const app = angular.module("categoryConfigApp", []);

        app.controller("categoryConfigCtrl", function ($scope, $http) {
            $scope.theText = '';
            $scope.theProperties = [];
            $scope.theClauses = [];
            $scope.theComparisonClauses = [];
            $scope.theComparison = [];
            $scope.redValue = 0.7;
            $scope.amberValue = 0.8;
            $scope.greenValue = 0.9;

            function addClass(item, clazz) {
                let element = document.getElementById(item);
                element.classList.add(clazz);
            }

            function removeClass(item, clazz) {
                let element = document.getElementById(item);
                element.classList.remove(clazz);
            }

            function uuidv4() {
                return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
            }

            $scope.showDialog = function () {
                $("#addComment").modal('show')
            }

            $scope.deleteClause = function (id) {
                $scope.theClauses = $scope.theClauses.filter(function (value, index, arr) {
                    return value.id != id;
                })
            }

            $scope.addClause = function (id) {
                let i = 0
                const newClause = {
                    "id": uuidv4(),
                    "value": ""
                }
                for (i = 0; i < $scope.theClauses.length; ++i) {
                    if ($scope.theClauses[i].id == id) {
                        break
                    }
                }
                $scope.theClauses.splice(i, 0, newClause);
            }

            $scope.combineWithClauseAbove = function (id) {
                let i = 0
                for (i = 0; i < $scope.theClauses.length; ++i) {
                    if ($scope.theClauses[i].id == id) {
                        break
                    }
                }
                if (i == 0) return
                $scope.theClauses[i - 1].value = $scope.theClauses[i - 1].value + " " + $scope.theClauses[i].value
                $scope.deleteClause(id)
            }

            $scope.combineWithClauseBelow = function (id) {
                let i = 0
                for (i = 0; i < $scope.theClauses.length; ++i) {
                    if ($scope.theClauses[i].id == id) {
                        break
                    }
                }
                if (i > $scope.theClauses.length - 1) return
                $scope.theClauses[i + 1].value = $scope.theClauses[i + 1].value + " " + $scope.theClauses[i].value
                $scope.deleteClause(id)
            }

            $scope.clauseFocus = function (id) {
                relevantResults = $scope.theComparison.filter(function (value, index, arr) {
                    return value['primary'] == id;
                })

                for (result of relevantResults)
                {
                    removeClass(result['secondary'], "iris-green-border")
                    removeClass(result['secondary'], "iris-amber-border")
                    removeClass(result['secondary'], "iris-red-border")

                    if (result['result'] > $scope.greenValue)
                    {
                        addClass(result['secondary'], "iris-green-border")
                    }
                    else if (result['result'] > $scope.amberValue)
                    {
                        addClass(result['secondary'], "iris-amber-border")
                    }
                    else if (result['result'] > $scope.redValue)
                    {
                        addClass(result['secondary'], "iris-red-border")
                    }
                }
            }

            $scope.uploadComparisonData = function () {
                if (document.getElementById("comparisonFileUploadInput").files.length == 0) {
                    return;
                }
                let theFile = document.getElementById("comparisonFileUploadInput").files[0];
                const file_url = "{{ tika_server }}" + "/tika/gettext?type=content";
                if (theFile != null) $scope.uploadComparisonFileToUrl(theFile, file_url);
            }

            $scope.uploadComparisonFileToUrl = function (file, target_url) {
                let form_data = new FormData();
                form_data.append("file", file);

                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: form_data,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.readComparisonClauses(response.data.result);
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.readComparisonClauses = function (theText) {
                const target_url = "{{ tika_server }}" + "/nlp/clauses";
                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: theText,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.theComparisonClauses = response.data;
                    $scope.doCompare()
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.doCompare = function () {
                const target_url = "/api/v1.0/comparelist";
                const method = "POST";
                let body = {}
                body['primary'] = $scope.theClauses
                body['secondary'] = $scope.theComparisonClauses
                $http({
                    method: method,
                    url: target_url,
                    data: body,
                    headers: {
                        'Content-Type': "application/json"
                    }
                }).then(function successCallback(response) {
                    $scope.theComparison = response.data
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }


            $scope.dumpClausesToDocument = function () {
                let paragraphs = []
                for (clause of $scope.theClauses) {
                    paragraphs.push(clause.value)
                }

                let element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(paragraphs.join("\n\n")));
                element.setAttribute('download', 'document.txt');

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }

            $scope.readClauses = function () {
                const target_url = "{{ tika_server }}" + "/nlp/clauses";
                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: $scope.theText,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.theClauses = response.data;
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.uploadOCRData = function () {
                if (document.getElementById("singleFileUploadInput").files.length == 0) {
                    return;
                }
                let theFile = document.getElementById("singleFileUploadInput").files[0];
                const file_url = "{{ tika_server }}" + "/tika/gettext?type=content";
                if (theFile != null) $scope.uploadFileToUrl(theFile, file_url);
            };

            $scope.uploadFileToUrl = function (file, target_url) {
                let form_data = new FormData();
                form_data.append("file", file);

                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: form_data,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.theText = response.data.result;
                    $scope.setProperties(response.data.properties)
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.setProperties = function (properties) {
                $('#theproperties').DataTable().destroy();
                $('#theproperties')
                    .DataTable({
                        "data": properties,
                        "columns": [
                            { "data": "key" },
                            { "data": "value" }]
                    })
            };
        });
    </script>

    <main class="container-fluid iris-main" ng-controller="categoryConfigCtrl" role="main">

        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs nav-fill" id="iris-tab-list" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" href="#text" role="tab">Text Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#properties" role="tab">Document Properties</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#clauses" role="tab">Document Clauses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#compare" role="tab">Document Comparison</a>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <h4 class="card-title">Admin Home Page</h4>
                <div class="tab-content">
                    <div class="tab-pane active" id="text" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users-cog"></i> Document
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-10 d-flex flex-column">
                                        <label for="sqlin">
                                            <i class="fas fa-code"></i>
                                            OCR Text
                                        </label>
                                        <textarea class="form-control iris-code flex-grow-1" id="sqlin"
                                            ng-model="theText" placeholder="Document Text" rows="20"></textarea>
                                    </div>
                                    <div class="col-2">
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <label for="source">
                                                <i class="fas fa-database"></i>
                                                Data Source
                                            </label>
                                            <div class="input-group">
                                                <select id="source" class="form-control" ng-model="source"
                                                    ng-options="source for source in sources">
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="isselect" type="checkbox"
                                                    value="">Is a
                                                select
                                                query
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="isvertical" type="checkbox"
                                                    value="">Vertical
                                                Output
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="isscript" type="checkbox"
                                                    value="">Is a
                                                script
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <button class="btn btn-primary btn-block" id="executebutton"
                                                ng-click="executeSQL()" type="submit">
                                                Execute
                                            </button>
                                        </div>
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <button class="btn btn-primary btn-block" id="clearButton"
                                                ng-click="clearResults()" type="submit">
                                                Clear Results
                                            </button>
                                        </div>
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <button class="btn btn-primary btn-block" id="clearAllButton"
                                                ng-click="clearAll()" type="submit">
                                                Clear All
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <input class="btn btn-primary" id="singleFileUploadInput" name="thefile"
                                            type="file" />
                                        <button class="btn btn-primary" id="uploadButton" ng-click="uploadOCRData()">
                                            Upload Document
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                            </div>
                        </div>
                    </div>

                    <div aria-labelledby="transitions-tab" class="tab-pane" id="properties" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Document Properties
                            </div>
                            <div class="card-body">
                                <table class="display compact" id="theproperties"
                                    style="width:100%; table-layout: fixed; word-wrap:break-word;">
                                    <thead>
                                        <tr>
                                            <th>Property Name</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div aria-labelledby="domains-tab" class="tab-pane" id="clauses" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chess"></i> Document Clauses
                            </div>
                            <div class="card-body">
                                <div ng-repeat="clause in theClauses" class="row">
                                    <div class="col-10">
                                        <textarea class="form-control iris-code flex-grow-1" ng-model="clause.value"
                                            rows="3"></textarea>
                                    </div>
                                    <div class="col-2">
                                        <div class="btn-group">
                                            <button class="btn btn-iris" ng-click="deleteClause(clause.id)"><i
                                                    class="fa fa-trash"></i></button>
                                            <button class="btn btn-iris" ng-click="addClause(clause.id)"><i
                                                    class="fa fa-plus"></i></button>
                                            <button class="btn btn-iris" ng-click="combineWithClauseAbove(clause.id)"><i
                                                    class="fa fa-arrow-circle-up"></i></button>
                                            <button class="btn btn-iris" ng-click="combineWithClauseBelow(clause.id)"><i
                                                    class="fa fa-arrow-circle-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary" ng-click="readClauses()">
                                    Get Clauses
                                </button>
                                <button class="btn btn-primary" ng-click="dumpClausesToDocument()">
                                    Download Document
                                </button>
                                <button class="btn btn-primary" ng-click="showDialog()">
                                    Dialog
                                </button>
                            </div>
                        </div>
                    </div>

                    <div aria-labelledby="transitions-tab" class="tab-pane" id="compare" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Document Compare
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div ng-repeat="clause in theClauses" class="row">
                                            <div class="col">
                                                <textarea ng-attr-id="{{from_clause_id}}"
                                                    class="form-control iris-code flex-grow-1"
                                                    ng-focus="clauseFocus(clause.id)" ng-model="clause.value" rows="3"
                                                    readonly></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div ng-repeat="clause in theComparisonClauses" class="row">
                                            <div class="col-10">
                                                <textarea ng-attr-id="{{to_clause_id}}"
                                                    class="form-control iris-code flex-grow-1" ng-model="clause.value"
                                                    rows="3" readonly></textarea>
                                            </div>
                                            <div class="col-2">
                                                <input type="text" class="form-control"
                                                    style="margin-bottom: 10px; margin-top: 2px;" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <input class="btn btn-primary" id="comparisonFileUploadInput" name="thefile"
                                        type="file" />
                                    <button class="btn btn-primary" id="comparisonUploadButton"
                                        ng-click="uploadComparisonData()">
                                        Upload Document
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </div>
    </main>

    {% include "dialog.html" %}

    <script type="text/javascript" src="/resources/js/tabs.js"></script>
</body>

</html>