<!--
  ~ Copyright (c) 2021. K2-Software
  ~ All software, both binary and source published by K2-Software (hereafter, Software) is copyrighted by the
  ~ author (hereafter, K2-Software) and ownership of all right, title and interest in and to the Software remains
  ~ with K2-Software. By using or copying the Software, User agrees to abide by the terms of this Agreement.
  -->

<!DOCTYPE HTML>

<head lang="en">
    <meta charset="UTF-8">
    <title>Text Tagger</title>

    <link rel="shortcut icon" type="image/ico" href="/resources/favicon.ico">

    <link rel="stylesheet" href="/resources/css/site.css" />

    <link rel="stylesheet" type="text/css" href="/resources/dist/bootstrap-4.3.1/css/bootstrap.min.css" />
    <link rel="stylesheet" type="text/css" href="/resources/dist/fontawesome-6.1.1/css/all.min.css" />
    <link rel="stylesheet" type="text/css" href="/resources/dist/datatables/datatables.min.css" />

    <script type="text/javascript" src="/resources/dist/jquery-3.6.0/jquery.min.js"></script>
    <script type="text/javascript" src="/resources/dist/bootstrap-4.3.1/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="/resources/dist/angularjs-1.8.2/angular.min.js"></script>
    <script type="text/javascript" src="/resources/dist/angularjs-1.8.2/angular-sanitize.min.js"></script>
    <script type="text/javascript" src="/resources/dist/datatables/datatables.min.js"></script>
    <script type="text/javascript" src="/resources/dist/chart-js-3.7.1/chart.min.js"></script>

    <script src="/resources/js/site.js"></script>
</head>

<body ng-app="categoryConfigApp">

    <script type="text/javascript">
        const app = angular.module("categoryConfigApp", ['ngSanitize']);

        app.controller("categoryConfigCtrl", function ($scope, $http) {
            $scope.lang = '<B>Language: </B><I>UNKNOWN</I>';
            $scope.theInitialText = '';
            $scope.theText = '';
            $scope.theProperties = [];
            $scope.theComparisonClauses = [];
            $scope.theTemplateClauses = [];
            $scope.theComparison = [];

            $scope.redValue = 70;
            $scope.amberValue = 80;
            $scope.greenValue = 90;

            $scope.options = {
                makeAlpha : false,
                removeSpace : false,
                removeStop : false,
                toLemma : false,
                removeDuplicates : false,
                expand : false,
                toLower : false
            }

            function addClass(item, clazz) {
                let text_element = document.getElementById(item);
                let prob_element = document.getElementById('P-' + item);
                text_element.classList.add(clazz);
                prob_element.classList.add(clazz);
            }

            function removeClass(item, clazz) {
                let text_element = document.getElementById(item);
                let prob_element = document.getElementById('P-' + item);
                text_element.classList.remove(clazz);
                prob_element.classList.remove(clazz);
            }

            function setProbabilities(probabilities) {
                for (item of probabilities)
                {
                    let prob_element = document.getElementById('P-' + item['secondary']);
                    prob = Math.round(item['result'] * 1000) / 1000
                    prob_element.value = prob
                }
            }

            $scope.executeCleanUp = function() {
                if ($scope.options.makeAlpha) $scope.makeAlphaNumeric()
                if ($scope.options.removeSpace) $scope.removeWhite()
                if ($scope.options.toLower) $scope.toLower()
            }

            $scope.removeWhite = function () {
                $scope.theText = $scope.theText.replace(/  +/g, ' ')
            }

            $scope.makeAlphaNumeric = function () {
                $scope.theText = $scope.theText.replace(/[^\n0-9a-zA-Z?!. ,;:-]/g, '')
            }

            $scope.toLower = function () {
                $scope.theText = $scope.theText.toLowerCase()
            }

            $scope.matchChart = null
            $scope.getBestMatch = function (relevantResults) {
                // Delete any existing chart
                if ($scope.matchChart != null) $scope.matchChart.destroy()
                theData = []
                theLabels = []
                for (result of relevantResults)
                {
                    theData.push(result['result'] * 100)
                    theLabels.push(result['secondary'])
                }
                const ctx = document.getElementById('best-match').getContext('2d');
                $scope.matchChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: theLabels,
                        datasets: [{
                            label: '% Match',
                            data: theData,
                            borderWidth: 1
                        }]
                    },
                    options: {
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }

            function uuidv4() {
                return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
            }

            $scope.revert = function() {
                $scope.theText = $scope.theInitialText
            }

            $scope.detectLanguage = function() {
                const target_url = "/api/v1.0/data/language";
                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: $scope.theText,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.lang = '<B>Language: </B><I>' + response.data.longname + '</I>';
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.deleteClause = function (id) {
                $scope.theComparisonClauses = $scope.theComparisonClauses.filter(function (value, index, arr) {
                    return value.id != id;
                })
            }

            $scope.addClause = function (id) {
                let i = 0
                const newClause = {
                    "id": uuidv4(),
                    "value": ""
                }
                for (i = 0; i < $scope.theComparisonClauses.length; ++i) {
                    if ($scope.theComparisonClauses[i].id == id) {
                        break
                    }
                }
                $scope.theComparisonClauses.splice(i, 0, newClause);
            }

            $scope.combineWithClauseAbove = function (id) {
                let i = 0
                for (i = 0; i < $scope.theComparisonClauses.length; ++i) {
                    if ($scope.theComparisonClauses[i].id == id) {
                        break
                    }
                }
                if (i == 0) return
                $scope.theComparisonClauses[i - 1].value = $scope.theComparisonClauses[i - 1].value + " " + $scope.theComparisonClauses[i].value
                $scope.deleteClause(id)
            }

            $scope.combineWithClauseBelow = function (id) {
                let i = 0
                for (i = 0; i < $scope.theComparisonClauses.length; ++i) {
                    if ($scope.theComparisonClauses[i].id == id) {
                        break
                    }
                }
                if (i > $scope.theComparisonClauses.length - 1) return
                $scope.theComparisonClauses[i + 1].value = $scope.theComparisonClauses[i + 1].value + " " + $scope.theComparisonClauses[i].value
                $scope.deleteClause(id)
            }

            $scope.clauseFocus = function (id) {
                relevantResults = $scope.theComparison.filter(function (value, index, arr) {
                    return value['primary'] == id;
                })
               
                setProbabilities(relevantResults)
                $scope.getBestMatch(relevantResults)
                for (result of relevantResults)
                {
                    removeClass(result['secondary'], "iris-green-border")
                    removeClass(result['secondary'], "iris-amber-border")
                    removeClass(result['secondary'], "iris-red-border")

                    if (result['result'] * 100 > $scope.greenValue)
                    {
                        addClass(result['secondary'], "iris-green-border")
                    }
                    else if (result['result'] * 100 > $scope.amberValue)
                    {
                        addClass(result['secondary'], "iris-amber-border")
                    }
                    else if (result['result'] * 100 > $scope.redValue)
                    {
                        addClass(result['secondary'], "iris-red-border")
                    }
                }
            }

            $scope.uploadComparisonData = function () {
                if (document.getElementById("comparisonFileUploadInput").files.length == 0) {
                    return;
                }
                let theFile = document.getElementById("comparisonFileUploadInput").files[0];
                const file_url = "{{ tika_server }}" + "/tika/gettext?type=content";
                if (theFile != null) $scope.uploadComparisonFileToUrl(theFile, file_url);
            }

            $scope.uploadComparisonFileToUrl = function (file, target_url) {
                let form_data = new FormData();
                form_data.append("file", file);

                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: form_data,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.readComparisonClauses(response.data.result);
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.readComparisonClauses = function (theText) {
                const target_url = "{{ tika_server }}" + "/nlp/clauses";
                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: theText,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.theTemplateClauses = response.data;
                    $scope.doCompare()
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.doCompare = function () {
                const target_url = "/api/v1.0/comparelist";
                const method = "POST";
                let body = {}
                body['primary'] = $scope.theTemplateClauses
                body['secondary'] = $scope.theComparisonClauses
                $http({
                    method: method,
                    url: target_url,
                    data: body,
                    headers: {
                        'Content-Type': "application/json"
                    }
                }).then(function successCallback(response) {
                    $scope.theComparison = response.data
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }


            $scope.dumpClausesToDocument = function () {
                let paragraphs = []
                for (clause of $scope.theComparisonClauses) {
                    paragraphs.push(clause.value)
                }

                let element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(paragraphs.join("\n\n")));
                element.setAttribute('download', 'document.txt');

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }

            $scope.readClauses = function () {
                const target_url = "{{ tika_server }}" + "/nlp/clauses";
                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: $scope.theText,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.theComparisonClauses = response.data;
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.uploadOCRData = function () {
                if (document.getElementById("singleFileUploadInput").files.length == 0) {
                    return;
                }
                let theFile = document.getElementById("singleFileUploadInput").files[0];
                const file_url = "{{ tika_server }}" + "/tika/gettext?type=content";
                if (theFile != null) $scope.uploadFileToUrl(theFile, file_url);
            };

            $scope.uploadFileToUrl = function (file, target_url) {
                let form_data = new FormData();
                form_data.append("file", file);

                const method = "POST";
                $http({
                    method: method,
                    url: target_url,
                    data: form_data,
                    headers: {
                        'Content-Type': undefined
                    }
                }).then(function successCallback(response) {
                    $scope.theInitialText = response.data.result;
                    $scope.theText = response.data.result;
                    $scope.detectLanguage()
                    $scope.setProperties(response.data.properties)
                }, function errorCallback(response) {
                    showFailure(response);
                });
            }

            $scope.setProperties = function (properties) {
                $('#theproperties').DataTable().destroy();
                $('#theproperties')
                    .DataTable({
                        "data": properties,
                        "columns": [
                            { "data": "key" },
                            { "data": "value" }]
                    })
            };

        });
    </script>

    <main class="container-fluid iris-main" ng-controller="categoryConfigCtrl" role="main">

        <div class="card">
            <div class="card-header">
                <ul class="nav nav-tabs nav-fill" id="iris-tab-list" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" href="#text" role="tab">Text Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#properties" role="tab">Document Properties</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#clauses" role="tab">Document Clauses</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#compare" role="tab">Document Comparison</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#charts" role="tab">Comparison Overview</a>
                    </li>
                </ul>
            </div>

            <div class="card-body">
                <h4 class="card-title">Document Comparison Demo</h4>
                <div class="tab-content">
                    <div class="tab-pane active" id="text" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-align-left"></i> Document
                            </div>
                            <div class="card-body">
                                <div class="row mb-3">
                                    <div class="col-10 d-flex flex-column">
                                        <label for="sqlin" ng-bind-html="lang">
                                        </label>
                                        <textarea class="form-control iris-code flex-grow-1" id="sqlin"
                                            ng-model="theText" placeholder="Document Text" rows="20"></textarea>
                                    </div>
                                    <div class="col-2">
                                        <div class="row mb-1"">
                                            <label for="sqlin">
                                            <i class="fas fa-cogs"></i>
                                            Options
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-select" type="checkbox"
                                                    ng-model="options.makeAlpha" value="">Make Alpha-Numeric
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-vertical" type="checkbox"
                                                    ng-model="options.removeSpace" value="">Remove excess whitespace
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-script" type="checkbox"
                                                    ng-model="options.removeStop" value="">Remove Stopwords
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-lemma" type="checkbox"
                                                    ng-model="options.toLemma" value="">Lemmatize 
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-duplicate" type="checkbox"
                                                    ng-model="options.removeDuplicates" value="">Remove Duplicates
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-expand" type="checkbox"
                                                    ng-model="options.expand" value="">Expand Contractions
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="margin-left: 10px;">
                                            <label class="form-check-label">
                                                <input class="form-check-input" id="is-lower" type="checkbox"
                                                    ng-model="options.toLower" value="">Lower Case
                                            </label>
                                        </div>
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <button class="btn btn-primary btn-block" id="clean-button"
                                                ng-click="executeCleanUp()" type="submit">
                                                Clean Text
                                            </button>
                                        </div>
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <button class="btn btn-primary btn-block" id="revert-button"
                                                ng-click="revert()" type="submit">
                                                Revert Text
                                            </button>
                                        </div>
                                        <div class="row mb-1" style="padding-right: 15px;">
                                            <button class="btn btn-primary btn-block" id="detect-button"
                                                ng-click="detectLanguage()" type="submit">
                                                Detect Language
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col">
                                        <input class="btn btn-primary" id="singleFileUploadInput" name="thefile"
                                            type="file" />
                                        <button class="btn btn-primary" id="uploadButton" ng-click="uploadOCRData()">
                                            Upload Document
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                            </div>
                        </div>
                    </div>

                    <div aria-labelledby="transitions-tab" class="tab-pane" id="properties" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Document Properties
                            </div>
                            <div class="card-body">
                                <table class="display compact" id="theproperties"
                                    style="width:100%; table-layout: fixed; word-wrap:break-word;">
                                    <thead>
                                        <tr>
                                            <th>Property Name</th>
                                            <th>Value</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                        </div>
                    </div>

                    <div aria-labelledby="domains-tab" class="tab-pane" id="clauses" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-chess"></i> Document Clauses
                            </div>
                            <div class="card-body">
                                <div ng-repeat="clause in theComparisonClauses" class="row">
                                    <div class="col-10">
                                        <textarea class="form-control iris-code flex-grow-1" ng-model="clause.value"
                                            rows="3"></textarea>
                                    </div>
                                    <div class="col-2">
                                        <div class="btn-group">
                                            <button class="btn btn-iris" ng-click="deleteClause(clause.id)"><i
                                                    class="fa fa-trash"></i></button>
                                            <button class="btn btn-iris" ng-click="addClause(clause.id)"><i
                                                    class="fa fa-plus"></i></button>
                                            <button class="btn btn-iris" ng-click="combineWithClauseAbove(clause.id)"><i
                                                    class="fa fa-arrow-circle-up"></i></button>
                                            <button class="btn btn-iris" ng-click="combineWithClauseBelow(clause.id)"><i
                                                    class="fa fa-arrow-circle-down"></i></button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-footer">
                                <button class="btn btn-primary" ng-click="readClauses()">
                                    Get Clauses
                                </button>
                                <button class="btn btn-primary" ng-click="dumpClausesToDocument()">
                                    Download Document
                                </button>
                            </div>
                        </div>
                    </div>

                    <div aria-labelledby="transitions-tab" class="tab-pane" id="compare" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                    <i class="fas fa-users"></i> Document Compare
                                <div class="row mt-3">
                                    <div class="col-4">
                                        <label for="red-slider" >Red Threshold
                                        </label>
                                        <div class="row">
                                            <div class="col-9">
                                                <input  id="red-slider" ng-model="redValue" class="form-control" type="range" min="1" max="100">
                                            </div>
                                            <div class="col-3">
                                                <input  id="red-val" ng-model="redValue" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <label for="amber-slider" >Amber Threshold
                                        </label>
                                        <div class="row">
                                            <div class="col-9">
                                                <input  id="amber-slider" ng-model="amberValue" class="form-control" type="range" min="1" max="100">
                                            </div>
                                            <div class="col-3">
                                                <input  id="amber-val" ng-model="amberValue" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-4">
                                        <label for="green-slider" >Green Threshold
                                        </label>
                                        <div class="row">
                                            <div class="col-9">
                                                <input  id="green-slider" ng-model="greenValue" class="form-control" type="range" min="1" max="100">
                                            </div>
                                            <div class="col-3">
                                                <input  id="green-val" ng-model="greenValue" class="form-control" type="text" readonly>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <div ng-repeat="clause in theTemplateClauses" class="row">
                                            <div class="col">
                                                <textarea ng-attr-id="{{from_clause_id}}"
                                                    class="form-control iris-code flex-grow-1"
                                                    ng-focus="clauseFocus(clause.id)" ng-model="clause.value" rows="3"
                                                    readonly></textarea>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div ng-repeat="clause in theComparisonClauses" class="row">
                                            <div class="col-10">
                                                <textarea ng-attr-id="{{to_clause_id}}"
                                                    class="form-control iris-code flex-grow-1" ng-model="clause.value"
                                                    rows="3" readonly></textarea>
                                            </div>
                                            <div class="col-2">
                                                {% autoescape false %}
                                                <input ng-attr-id="{{to_prob_id}}" type="text" class="form-control"
                                                    style="margin-bottom: 10px; margin-top: 2px;" readonly>
                                                {% endautoescape %}                                                
                                                </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-footer">
                                    <input class="btn btn-primary" id="comparisonFileUploadInput" name="thefile"
                                        type="file" />
                                    <button class="btn btn-primary" id="comparisonUploadButton"
                                        ng-click="uploadComparisonData()">
                                        Upload Template
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div aria-labelledby="transitions-tab" class="tab-pane" id="charts" role="tabpanel">
                        <div class="card">
                            <div class="card-header">
                                <i class="fas fa-users"></i> Comparison Overview
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-6">
                                        <canvas id="best-match" width="200" height="200"></canvas>
                                    </div>
                                    <div class="col-6">
                                        <canvas id="overall-match" width="200" height="200"></canvas>
                                    </div>
                                </div>
                                <div class="card-footer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script type="text/javascript" src="/resources/js/tabs.js"></script>
</body>

</html>